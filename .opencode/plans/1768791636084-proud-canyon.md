# Flom 実装計画

## 概要

`flom` はあらゆる変換ができる汎用CLIツール。最初のバージョンでは Apple Music <-> Spotify URL 変換を実装する。

## プロジェクト構成

```
flom/
├── Cargo.toml                 # Workspace configuration
├── crates/
│   ├── flom/                  # CLIエントリポイント
│   │   ├── Cargo.toml
│   │   └── src/
│   │       └── main.rs        # CLI定義・エントリーポイント
│   ├── flom-core/             # 共通のtrait・エラー処理
│   │   ├── Cargo.toml
│   │   └── src/
│   │       ├── error.rs       # エラー型定義
│   │       ├── lib.rs         # 共通トレイト
│   │       └── result.rs      # 変換結果型
│   ├── flom-music/            # 音楽ストリーミング変換
│   │   ├── Cargo.toml
│   │   └── src/
│   │       ├── parsers/
│   │       │   ├── mod.rs
│   │       │   ├── spotify.rs # Spotify URLパーサー
│   │       │   └── apple_music.rs # Apple Music URLパーサー
│   │       ├── api/
│   │       │   ├── mod.rs
│   │       │   ├── musicbrainz.rs # MusicBrainz API
│   │       │   └── odesli.rs      # Odesli API
│   │       ├── converter.rs   # 変換ロジック
│   │       └── lib.rs
│   ├── flom-url/              # 一般的なURL変換
│   │   ├── Cargo.toml
│   │   └── src/
│   │       └── lib.rs         # 将来的な拡張用
│   ├── flom-shorten/          # URL短縮
│   │   ├── Cargo.toml
│   │   └── src/
│   │       ├── mod.rs
│   │       └── lib.rs
│   └── flom-config/           # 設定管理
│       ├── Cargo.toml
│       └── src/
│           ├── mod.rs
│           └── config.rs     # TOML設定ファイル管理
```

## 依存関係

### flom (CLI)
- `clap` (CLIパーサー)
- `tokio` (非同期ランタイム)
- `crossterm` (ターミナル操作)
- `dialoguer` (対話的UI)
- `flom-core`
- `flom-music`
- `flom-shorten`
- `flom-config`

### flom-core
- `thiserror` (エラー処理)
- `serde` (シリアライズ)

### flom-music
- `url` (URLパース)
- `reqwest` (HTTPクライアント)
- `serde` / `serde_json`
- `regex` (URLマッチング)

### flom-shorten
- `url`
- `reqwest`

### flom-config
- `serde`
- `serde_toml`
- `dirs` (設定ファイルパス)

## 実装ステップ

### ステップ1: 基本構造のセットアップ
1. ワークスペース構成の作成
2. 各crateの Cargo.toml 作成
3. 基本的なモジュール構造の作成

**変更するファイル:**
- `Cargo.toml` (新規)
- `crates/flom/Cargo.toml` (更新)
- `crates/flom-core/Cargo.toml` (新規)
- `crates/flom-music/Cargo.toml` (新規)
- `crates/flom-url/Cargo.toml` (新規)
- `crates/flom-shorten/Cargo.toml` (新規)
- `crates/flom-config/Cargo.toml` (新規)

### ステップ2: flom-core (共通ロジック)
1. エラー型の定義
2. 変換結果型の定義
3. 共通トレイトの定義

**変更するファイル:**
- `crates/flom-core/src/error.rs` (新規)
- `crates/flom-core/src/result.rs` (新規)
- `crates/flom-core/src/lib.rs` (新規)

### ステップ3: flom-config (設定管理)
1. 設定ファイルのTOML形式定義
2. 環境変数からの読み込み
3. 初期設定フロー（初回起動時の対話的入力）

**変更するファイル:**
- `crates/flom-config/src/config.rs` (新規)
- `crates/flom-config/src/lib.rs` (新規)

**設定ファイルフォーマット (~/.flom/config.toml):**
```toml
[api]
odesli_key = "" # 空の場合、無料キーを使用

[default]
target = "applemusic" # デフォルトの変換先

[output]
simple = false # trueの場合、URLのみ出力
```

### ステップ4: flom-music (音楽URL変換)
1. URLパーサーの実装（Spotify, Apple Music）
2. MusicBrainz API クライアント
3. Odesli API クライアント
4. 変換ロジック

**変更するファイル:**
- `crates/flom-music/src/parsers/spotify.rs` (新規)
- `crates/flom-music/src/parsers/apple_music.rs` (新規)
- `crates/flom-music/src/api/musicbrainz.rs` (新規)
- `crates/flom-music/src/api/odesli.rs` (新規)
- `crates/flom-music/src/converter.rs` (新規)
- `crates/flom-music/src/lib.rs` (新規)

**変換ロジック:**
1. 入力URLからプラットフォームとトラックIDを抽出
2. MusicBrainz APIでトラック情報を検索
3. ターゲットプラットフォームのURLを生成
4. 直接変換できない場合、Odesli共有ページを生成

### ステップ5: flom-shorten (URL短縮)
1. is.gd などの無料短縮サービスとの連携
2. 短縮APIクライアント

**変更するファイル:**
- `crates/flom-shorten/src/lib.rs` (新規)

### ステップ6: flom (CLI実装)
1. ClapによるCLI定義
2. 複数入力方法のサポート（単一URL、複数URL、ファイル、標準入力）
3. Crosstermによる対話的UI
4. 結果の描画
5. サマリー表示

**変更するファイル:**
- `crates/flom/src/main.rs` (新規)

**CLI構造:**
```
flom [OPTIONS] <URL>...

# 変換先を指定して変換
flom https://open.spotify.com/track/abc123 --to applemusic

# 変換先を省略（対話的に選択）
flom https://open.spotify.com/track/abc123

# 複数URL
flom "url1" "url2" "url3" --to applemusic

# ファイルから読み込み
flom --input urls.txt --to applemusic

# 標準入力
cat urls.txt | flom --to applemusic

# URL短縮
flom --shorten "URL"

# シンプル出力（URLのみ）
flom "URL" --to applemusic --simple
```

### ステップ7: 対話的UIの実装
1. --to を省略した場合の変換先選択
2. 初回起動時のAPIキー入力
3. 変換結果の表示

**対話的UIの例:**
```
$ flom https://open.spotify.com/track/abc123

Select target platform:
  [ ] Apple Music
  [ ] YouTube Music
  [ ] Tidal
  [ ] All

[↑↓ Move, Space to select, Enter to confirm]

✓ Converting: Spotify Track - "Blinding Lights" by The Weeknd
  To: Apple Music Track
  URL: https://music.apple.com/us/album/blinding-lights/1496794033?i=1496794038

✓ Converting: Spotify Track - "Blinding Lights" by The Weeknd
  To: YouTube Music
  URL: https://music.youtube.com/watch?v=abc123

Summary:
  Total: 1
  Success: 1
  Failed: 0
```

### ステップ8: テスト
1. ユニットテスト（URLパーサー）
2. 統合テスト（変換ロジック）
3. E2Eテスト（CLI）

**変更するファイル:**
- `crates/flom-music/tests/` (新規)
- `crates/flom/tests/` (新規)

**テスト用URL:**
- Spotify: `https://open.spotify.com/track/4cOdK2wGLETKBW3PvgPWqT` (Blinding Lights)
- Apple Music: `https://music.apple.com/us/album/blinding-lights/1496794033?i=1496794038`

## 実装順序

1. **基本構造のセットアップ** (30分)
2. **flom-core 実装** (30分)
3. **flom-config 実装** (1時間)
4. **flom-music 実装** (3時間)
   - URLパーサー (1時間)
   - MusicBrainz API (1時間)
   - 変換ロジック (1時間)
5. **flom-shorten 実装** (30分)
6. **flom (CLI) 実装** (3時間)
   - CLI定義 (1時間)
   - 入力処理 (1時間)
   - 対話的UI (1時間)
7. **テスト** (1時間)
8. **ドキュメント・README** (1時間)

**合計時間**: 約10.5時間

## 検証方法

### 1. 単一URL変換
```bash
cargo run -- -- https://open.spotify.com/track/4cOdK2wGLETKBW3PvgPWqT --to applemusic
```
期待結果: Apple Music URLとトラック情報が表示される

### 2. 対話的変換
```bash
cargo run -- -- https://open.spotify.com/track/4cOdK2wGLETKBW3PvgPWqT
```
期待結果: 変換先選択メニューが表示され、選択後に結果が表示される

### 3. 複数URL
```bash
cargo run -- -- "url1" "url2" "url3" --to applemusic
```
期待結果: 全てのURLが変換され、サマリーが表示される

### 4. ファイル入力
```bash
echo "https://open.spotify.com/track/4cOdK2wGLETKBW3PvgPWqT" > urls.txt
cargo run -- --input urls.txt --to applemusic
```
期待結果: ファイル内のURLが変換される

### 5. 標準入力
```bash
cat urls.txt | cargo run -- --to applemusic
```
期待結果: パイプで渡されたURLが変換される

### 6. URL短縮
```bash
cargo run -- --shorten https://music.apple.com/us/album/blinding-lights/1496794033?i=1496794038
```
期待結果: 短縮URLが表示される

### 7. シンプル出力
```bash
cargo run -- -- https://open.spotify.com/track/4cOdK2wGLETKBW3PvgPWqT --to applemusic --simple
```
期待結果: URLのみが表示される

### 8. エラーハンドリング
```bash
cargo run -- -- https://example.com/invalid --to applemusic
```
期待結果: エラーメッセージが表示され、処理が続行される

## 技術的な決定事項

### API戦略
- **MusicBrainz API**: メタデータ取得のメイン（無料・無制限）
- **Odesli API**: 直接変換できない場合のフォールバック（オプション）
- **スクレイピング**: 最後の手段（信頼性が低いため）

### URL形式
- ゆるいマッチングを使用（モバイルURL、地域URL、埋め込みURLに対応）
- 正規表現でID部分を抽出し、標準URLに正規化

### エラー処理
- 全ての変換を並列で実行
- エラーがあっても処理を続行
- 最後に成功数/失敗数のサマリーを表示

### 設定管理
- 環境変数: `FLOM_odesli_key`, `FLOM_default_target`
- 設定ファイル: `~/.flom/config.toml`
- 優先順位: コマンドライン引数 > 環境変数 > 設定ファイル

## 次のステップ

実装を開始する前に、以下の確認が必要：

1. ✅ crates.io での名称確認
   - "flom" は使用可能
   - 類似名称: "floem" (UIライブラリ), "flume" (チャネルライブラリ) - いずれも異なるカテゴリ

2. ✅ 機能要件の確定
   - Apple Music <-> Spotify 変換
   - URL短縮
   - 対話的UI

3. ✅ 技術スタックの決定
   - Rust 2024 edition
   - Clap, Tokio, Crossterm
   - MusicBrainz API

4. ❓ Odesli API Key についての確認
   - ユーザーが公式Notionページ（https://linktree.notion.site/API-d0ebe08a5e304a55928405eb682f6741）を発見
   - NotionページはJavaScriptが必要なため、現在の内容を確認できていない
   - 現在の実装ではAPIキーはオプション（Option<String>）
   - 公式のodesli-rsライブラリもAPIキーをオプションとして扱っている
   - 公式Notionページの内容を共有していただくか、またはAPIキーが不要になったことを確認が必要

**質問**: Notionページにはどのような情報が書かれていますか？（APIキーが完全に不要になったのか、制限が変わったのかなど）

実装を開始して良いか確認。
