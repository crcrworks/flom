# API KEY Handling Refactor Plan

## Overview
Change the API KEY handling behavior so that:
1. **API KEYなし is the default** - don't prompt if config file exists
2. **Use config file if it exists** - only prompt on first run
3. **Always create config file on first run** - even if user skips API KEY input

## Requirements

### Primary Requirements
1. **When config file EXISTS** (`~/.flom/config.toml`):
   - Use environment variable `FLOM_ODESLI_KEY` if set
   - Otherwise use value from config file (even if `None`)
   - **NEVER prompt for API key**
   - Execute with API KEY if value exists, without if value is `None`

2. **When config file DOESN'T EXIST**:
   - Use environment variable `FLOM_ODESLI_KEY` if set
   - Otherwise, prompt user for API key (first-time setup)
   - **ALWAYS create config file** after prompt (empty or with API key)
   - If user presses Enter (empty input), create config file without API key
   - If user provides API key, save it to config file

3. **Additional features**:
   - Allow adding API KEY via command: `flom config set api.odesli-key <key>`
   - Allow manual editing of config file: `flom config edit`

## Files to Modify

### Phase 1: Core Configuration Changes (flom-config)

1. **`crates/flom-config/Cargo.toml`**
   - Add dependency: `toml_edit = "0.22"`

2. **`crates/flom-config/src/lib.rs`**
   - Add `config_exists()` function to check if config file exists
   - Add `set_config_value()` function to set nested config values
   - Add `open_in_editor()` function to open config in `$EDITOR`

### Phase 2: CLI Structure Changes (flom)

3. **`crates/flom/src/main.rs`**
   - Add `Commands` enum (with subcommands: `config`)
   - Add `ConfigAction` enum (with actions: `get`, `set`, `list`, `edit`)
   - Modify `Cli` struct to include `command` field
   - Replace `resolve_or_prompt_odesli_key()` with new version that checks `config_exists()`
   - Add `handle_config_command()` function to process config subcommands
   - Add `get_nested_config_value()` helper for accessing nested values
   - Update `main()` to handle config commands before URL processing

### Phase 3: Testing

4. **`crates/flom-config/src/lib.rs`**
   - Add unit tests for new functions

5. **`tests/config_commands.rs`**
   - Create integration tests for config commands

## Implementation Details

### 1. flom-config Changes

#### Add dependency to `Cargo.toml`:
```toml
[dependencies]
# ... existing dependencies ...
toml_edit = "0.22"
```

#### Add functions to `lib.rs`:

**`config_exists()`** - Check if config file exists:
```rust
pub fn config_exists() -> FlomResult<bool> {
    let path = config_path()?;
    Ok(path.exists())
}
```

**`set_config_value()`** - Set nested config values using dot notation:
```rust
pub fn set_config_value(key_path: &str, value: &str) -> FlomResult<()> {
    let path = config_path()?;
    let content = if path.exists() {
        fs::read_to_string(&path)?
    } else {
        String::new()
    };

    let mut doc = content.parse::<toml_edit::Document>()
        .unwrap_or_default();

    let parts: Vec<&str> = key_path.split('.').collect();
    if parts.len() < 2 {
        return Err(FlomError::Config("key path must have at least 2 parts (e.g., 'api.odesli_key')".to_string()));
    }

    let table = doc.as_table_mut();
    let mut current = table;
    for part in &parts[..parts.len()-1] {
        current = current.entry(part).or_insert(toml_edit::Item::Table(Default::default())).as_table_mut()
            .ok_or_else(|| FlomError::Config(format!("cannot set nested value in '{}'", key_path)))?;
    }

    let last_part = parts.last().unwrap();
    current[last_part] = toml_edit::value(value);

    let content = doc.to_string();
    if let Some(parent) = path.parent() {
        fs::create_dir_all(parent)?;
    }
    fs::write(&path, content)?;

    Ok(())
}
```

**`open_in_editor()`** - Open config file in `$EDITOR`:
```rust
pub fn open_in_editor() -> FlomResult<()> {
    let path = config_path()?;
    if !path.exists() {
        save_config(&FlomConfig::default())?;
    }

    let editor = env::var("EDITOR").unwrap_or_else(|_| {
        if cfg!(target_os = "macos") {
            "vim".to_string()
        } else if cfg!(target_os = "windows") {
            "notepad".to_string()
        } else {
            "nano".to_string()
        }
    });

    let status = Command::new(&editor)
        .arg(&path)
        .status()
        .map_err(|err| FlomError::Config(format!("failed to open editor '{}': {}", editor, err)))?;

    if !status.success() {
        return Err(FlomError::Config(format!("editor exited with status: {}", status)));
    }

    Ok(())
}
```

### 2. flom Changes

#### Add command enums:

```rust
use clap::{Parser, Subcommand};

#[derive(Subcommand, Debug)]
enum Commands {
    /// Manage configuration
    Config {
        #[command(subcommand)]
        action: ConfigAction,
    },
}

#[derive(Subcommand, Debug)]
enum ConfigAction {
    /// Get a configuration value
    Get {
        key: String,
    },
    /// Set a configuration value
    Set {
        key: String,
        value: String,
    },
    /// List all configuration values
    List,
    /// Open config file in editor
    Edit,
}

#[derive(Parser, Debug)]
#[command(author, version, about)]
struct Cli {
    /// URLs to convert
    #[arg(value_name = "URL")]
    urls: Vec<String>,

    /// Output format (json, simple)
    #[arg(short, long)]
    format: Option<String>,

    #[command(subcommand)]
    command: Option<Commands>,
}
```

#### Modify `resolve_or_prompt_odesli_key()`:

```rust
fn resolve_or_prompt_odesli_key(config: &mut FlomConfig) -> Option<String> {
    // Check environment variable first
    if let Ok(value) = env::var("FLOM_ODESLI_KEY") {
        if !value.trim().is_empty() {
            return Some(value);
        }
    }

    // If config file exists, use its value (never prompt)
    if flom_config::config_exists().unwrap_or(false) {
        return config.api.odesli_key.clone();
    }

    // Config file doesn't exist - first time setup
    let theme = ColorfulTheme::default();
    println!("{} {}",
        style("First-time setup:").bold().cyan(),
        "Let's configure your flom settings"
    );

    let input: String = Input::with_theme(&theme)
        .with_prompt("Odesli API key (optional, press Enter to skip)")
        .allow_empty(true)
        .interact_text()
        .unwrap_or_default();

    if !input.trim().is_empty() {
        config.api.odesli_key = Some(input.clone());
    }

    // Always create config file on first run
    if let Err(err) = flom_config::save_config(config) {
        eprintln!("{} {err}", style("Warning:").yellow());
    } else {
        println!("{} Config file created at ~/.flom/config.toml",
            style("✓").green());
    }

    config.api.odesli_key.clone()
}
```

#### Add `handle_config_command()`:

```rust
fn handle_config_command(action: ConfigAction) -> FlomResult<()> {
    match action {
        ConfigAction::Get { key } => {
            let config = flom_config::load_config()?;
            let value = get_nested_config_value(&config, &key);
            match value {
                Some(v) => println!("{} = {}", key, v),
                None => println!("{} = <null>", key),
            }
            Ok(())
        }
        ConfigAction::Set { key, value } => {
            flom_config::set_config_value(&key, &value)?;
            println!("{} Set {} = {}",
                style("✓").green(), key, value);
            Ok(())
        }
        ConfigAction::List => {
            let config = flom_config::load_config()?;
            println!("Current configuration:");
            println!("\n[api]");
            println!("odesli_key = {}", config.api.odesli_key.as_deref().unwrap_or("<null>"));
            println!("\n[default]");
            println!("target = {}", config.default.target.as_deref().unwrap_or("<null>"));
            println!("\n[output]");
            println!("simple = {}", config.output.simple.unwrap_or(false));
            Ok(())
        }
        ConfigAction::Edit => {
            flom_config::open_in_editor()?;
            Ok(())
        }
    }
}
```

#### Add `get_nested_config_value()` helper:

```rust
fn get_nested_config_value(config: &FlomConfig, key_path: &str) -> Option<String> {
    let parts: Vec<&str> = key_path.split('.').collect();

    match parts.as_slice() {
        ["api", "odesli_key"] => config.api.odesli_key.clone(),
        ["default", "target"] => config.default.target.clone(),
        ["output", "simple"] => config.output.simple.map(|b| b.to_string()),
        _ => None,
    }
}
```

#### Update `main()`:

```rust
#[tokio::main]
async fn main() -> FlomResult<()> {
    let cli = Cli::parse();

    // Handle config commands first
    if let Some(Commands::Config { action }) = cli.command {
        return handle_config_command(action);
    }

    // Rest of the main function remains the same...
    // ...
}
```

## Testing Strategy

### Unit Tests (flom-config)
- Test `config_exists()` returns correct boolean
- Test `set_config_value()` with various key paths
- Test `open_in_editor()` (may need mocking)

### Integration Tests
1. **First run (no config file)**:
   - Run with URL, should prompt for API key
   - Verify config file is created
   - Run again with URL, should NOT prompt

2. **Config file exists with no API key**:
   - Create config file without `odesli_key`
   - Run with URL, should NOT prompt
   - Should execute with no API key

3. **Config file exists with API key**:
   - Create config file with `odesli_key = "test-key"`
   - Run with URL, should use "test-key" without prompting

4. **Environment variable override**:
   - Set `FLOM_ODESLI_KEY=env-key`
   - Run with URL, should use "env-key" regardless of config

5. **Config commands**:
   - `flom config list` - shows current config
   - `flom config get api.odesli_key` - shows API key
   - `flom config set api.odesli-key new-key` - sets API key
   - `flom config edit` - opens in editor

## Verification Steps

After implementation, manually test:

1. Remove `~/.flom/config.toml` if it exists
2. Run `flom <url>` - should prompt for API key and create config file
3. Run `flom <url>` again - should NOT prompt
4. Run `flom config list` - should show config
5. Run `flom config set api.odesli-key test123` - should set API key
6. Run `flom config get api.odesli_key` - should show "test123"
7. Set `FLOM_ODESLI_KEY=env456` and run `flom <url>` - should use "env456"
8. Edit config file manually and verify changes are respected
9. Run `flom config edit` - should open config in editor
